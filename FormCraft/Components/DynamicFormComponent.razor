@*
A dynamic form component that renders forms based on configuration and provides automatic validation.
This component coordinates field rendering, validation, and form submission for type-safe dynamic forms.
*@

@namespace FormCraft
@typeparam TModel where TModel : new()
@inject IFieldRendererService FieldRendererService

<EditForm Model="@Model" OnValidSubmit="@OnSubmit">
    <DataAnnotationsValidator />
    <DynamicFormValidator TModel="TModel" Configuration="@Configuration" />
    
    <div class="@GetFormLayoutClass()">
        @foreach (var field in Configuration.Fields.OrderBy(f => f.Order))
        {
            @if (ShouldShowField(field))
            {
                <div class="@GetFieldLayoutClass(field) mb-4">
                    <div class="form-field-container">
                        @FieldRendererService.RenderField(Model, field, 
                            EventCallback.Factory.Create<object?>(this, value => HandleFieldValueChanged(field.FieldName, value)),
                            EventCallback.Factory.Create(this, () => HandleFieldDependencyChanged(field.FieldName)))
                        <FieldValidationMessage FieldName="@field.FieldName" />
                    </div>
                </div>
            }
        }
    </div>
    
    @if (ShowSubmitButton)
    {
        <MudCardActions Class="justify-center pa-4">
            <MudButton ButtonType="ButtonType.Submit"
                      Variant="Variant.Filled"
                      Color="Color.Primary"
                      Size="Size.Large"
                      Disabled="@IsSubmitting"
                      StartIcon="@(IsSubmitting ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Send)"
                      Class="@SubmitButtonClass">
                @if (IsSubmitting)
                {
                    <MudProgressCircular Class="me-2" Size="Size.Small" Indeterminate="true" />
                    <span>@SubmittingText</span>
                }
                else
                {
                    <span>@SubmitButtonText</span>
                }
            </MudButton>
        </MudCardActions>
    }
</EditForm>