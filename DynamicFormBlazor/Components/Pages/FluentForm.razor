@page "/fluent"
@using DynamicFormBlazor.Models
@using DynamicFormBlazor.Components.Shared
@using DynamicFormBlazor.Components.Layout
@using FormCraft

<PageTitle>Fluent API Dynamic Form</PageTitle>

<FormPageLayout PageTitle="Fluent API Dynamic Form"
                PageDescription="This demonstrates the fluent API with helper methods for common field types and streamlined form building."
                PageIcon="@Icons.Material.Filled.FlashOn"
                FormTitle="Contact Information Form"
                FormIcon="@Icons.Material.Filled.ContactPage">
    
    <FormContent>
        <DynamicFormComponent TModel="ContactModel" 
                            Model="@_model" 
                            Configuration="@_formConfiguration"
                            OnValidSubmit="@HandleValidSubmit"
                            OnFieldChanged="@(args => HandleFieldChanged(args.fieldName, args.value))"
                            IsSubmitting="@_isSubmitting"
                            ShowSubmitButton="true"
                            SubmitButtonText="Submit Information"
                            SubmittingText="Submitting..."
                            SubmitButtonClass="px-8" />
    </FormContent>
    
    <SidebarContent>
        <FormGuidelines Guidelines="@_guidelines" Title="Fluent API Features" />
        
        <MudCard Elevation="2" Class="mt-4">
            <MudCardContent>
                <MudText Typo="Typo.h6" GutterBottom="true" Class="d-flex align-items-center">
                    <MudIcon Icon="@Icons.Material.Filled.Code" Class="me-2 text-info" />
                    Fluent Methods Example
                </MudText>
                <MudPaper Class="pa-3" Elevation="1">
                    <pre style="font-size: 11px; line-height: 1.3; white-space: pre-wrap; color: #2d3748;">FormBuilder&lt;ContactModel&gt;
    .Create()
    .WithLayout(FormLayout.Horizontal)
    .AddRequiredTextField(x => x.FirstName, 
        "First Name", "Enter first name", 2)
    .AddEmailField(x => x.Email)
    .AddNumericField(x => x.Age, "Age", 16, 100)
    .AddDropdownField(x => x.Country, "Country",
        ("US", "United States"),
        ("CA", "Canada"))
    .Build();</pre>
                </MudPaper>
            </MudCardContent>
        </MudCard>
        
        <MudCard Elevation="2" Class="mt-4">
            <MudCardContent>
                <MudText Typo="Typo.h6" GutterBottom="true" Class="d-flex align-items-center">
                    <MudIcon Icon="@Icons.Material.Filled.LiveHelp" Class="me-2 text-info" />
                    Need Help?
                </MudText>
                <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                    <MudText Typo="Typo.body2">
                        Having trouble? Contact our support team at 
                        <MudLink Href="mailto:support@example.com">support@example.com</MudLink>
                    </MudText>
                </MudAlert>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Info" 
                          Size="Size.Small"
                          StartIcon="@Icons.Material.Filled.Phone"
                          FullWidth="true">
                    Call Support: 1-800-HELP
                </MudButton>
            </MudCardContent>
        </MudCard>
    </SidebarContent>
    
    <SuccessContent>
        @if (_isSubmitted)
        {
            <FormSuccessDisplay TModel="ContactModel" 
                               DataDisplayItems="@GetDataDisplayItems()"
                               OnReset="@ResetForm" />
        }
    </SuccessContent>
    
</FormPageLayout>

@code {
    private ContactModel _model = new();
    private bool _isSubmitted;
    private bool _isSubmitting;
    private List<string> _fieldChanges = new();
    private IFormConfiguration<ContactModel> _formConfiguration = null!;
    
    private List<FormGuidelines.GuidelineItem> _guidelines = new()
    {
        new() { Icon = Icons.Material.Filled.FlashOn, Color = Color.Primary, Text = "Fluent helper methods for common fields" },
        new() { Icon = Icons.Material.Filled.Speed, Color = Color.Secondary, Text = "Streamlined form building process" },
        new() { Icon = Icons.Material.Filled.AutoAwesome, Color = Color.Tertiary, Text = "Automatic validation and layout" },
        new() { Icon = Icons.Material.Filled.Tune, Color = Color.Info, Text = "Configurable form layouts" },
        new() { Icon = Icons.Material.Filled.Security, Color = Color.Success, Text = "Built-in field validation rules" },
        new() { Icon = Icons.Material.Filled.Psychology, Color = Color.Warning, Text = "Intelligent dependency handling" }
    };
    
    protected override void OnInitialized()
    {
        // Much simpler form creation using fluent methods
        _formConfiguration = FormBuilder<ContactModel>
            .Create()
            .WithLayout(FormLayout.Horizontal)
            .AddRequiredTextField(x => x.FirstName, "First Name", "Enter your first name", 2)
            .AddRequiredTextField(x => x.LastName, "Last Name", "Enter your last name", 2)
            .AddEmailField(x => x.Email)
            .AddNumericField(x => x.Age, "Age", 16, 100)
            .AddField(x => x.ExpectedSalary)
                .WithLabel("Expected Salary")
                .WithPlaceholder("$0.00")
                .WithHelpText("Enter amount in $")
            .AddField(x => x.HourlyRate)
                .WithLabel("Hourly Rate")
                .WithPlaceholder("50.00")
                .WithHelpText("Enter hourly rate")
            .AddField(x => x.Country)
                .WithLabel("Country")
                .Required("Please select a country")
                .WithOptions(
                ("US", "United States"),
                ("CA", "Canada"),
                ("UK", "United Kingdom"),
                ("DE", "Germany"),
                ("FR", "France")
                )
            .AddField(x => x.City)
                .WithLabel("City")
                .WithPlaceholder("Enter your city")
                .VisibleWhen(m => !string.IsNullOrEmpty(m.Country))
                .DependsOn(x => x.Country, (model, country) =>
                {
                    if (string.IsNullOrEmpty(country))
                    {
                        model.City = null;
                    }
                })
                .AddField(x => x.SubscribeToNewsletter)
                .WithLabel("Subscribe to Newsletter")
                .WithHelpText("Get updates about new features")
            .Build();
    }
    
    private async Task HandleValidSubmit(ContactModel submittedModel)
    {
        _isSubmitting = true;
        StateHasChanged();
        
        // Simulate API call
        await Task.Delay(2000);
        
        _isSubmitted = true;
        _isSubmitting = false;
        StateHasChanged();
    }
    
    private void ResetForm()
    {
        _model = new ContactModel();
        _isSubmitted = false;
        _isSubmitting = false;
        _fieldChanges.Clear();
        StateHasChanged();
    }
    
    private Task HandleFieldChanged(string fieldName, object? value)
    {
        _fieldChanges.Add($"{DateTime.Now:HH:mm:ss} - {fieldName}: {value}");
        StateHasChanged();
        return Task.CompletedTask;
    }
    
    private List<FormSuccessDisplay<ContactModel>.DataDisplayItem> GetDataDisplayItems()
    {
        var items = new List<FormSuccessDisplay<ContactModel>.DataDisplayItem>
        {
            new() { Label = "Full Name", Value = $"{_model.FirstName} {_model.LastName}" },
            new() { Label = "Email", Value = _model.Email },
            new() { Label = "Age", Value = $"{_model.Age} years old" },
            new() { Label = "Country", Value = _model.Country }
        };
        
        if (!string.IsNullOrEmpty(_model.City))
            items.Add(new() { Label = "City", Value = _model.City });
            
        if (_model.ExpectedSalary.HasValue)
            items.Add(new() { Label = "Expected Salary", Value = $"${_model.ExpectedSalary.Value:N2}" });
            
        if (_model.HourlyRate.HasValue)
            items.Add(new() { Label = "Hourly Rate", Value = $"${_model.HourlyRate.Value:N2}/hr" });
            
        items.Add(new() { Label = "Newsletter", Value = _model.SubscribeToNewsletter ? "Subscribed" : "Not Subscribed" });
        
        if (_fieldChanges.Any())
            items.Add(new() { Label = "Field Changes", Value = $"{_fieldChanges.Count} changes tracked" });
        
        return items;
    }
}