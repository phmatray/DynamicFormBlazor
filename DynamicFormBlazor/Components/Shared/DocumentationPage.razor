@using DynamicFormBlazor.Services
@inject IMarkdownService MarkdownService
@inject IJSRuntime JSRuntime

<PageTitle>@Title - Dynamic Form Blazor</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudGrid>
        <MudItem xs="12" lg="9">
            <MudCard Elevation="2">
                <MudCardContent>
                    @if (isLoading)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                        <MudText Class="mt-4" Align="Align.Center">Loading documentation...</MudText>
                    }
                    else
                    {
                        <div class="markdown-content">
                            @((MarkupString)htmlContent)
                        </div>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" lg="3">
            <MudCard Elevation="1">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Table of Contents</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudNavMenu>
                        @foreach (var tocSection in tableOfContents)
                        {
                            <MudNavLink OnClick="@(() => ScrollToSection(tocSection.Id))">
                                @tocSection.Title
                            </MudNavLink>
                        }
                    </MudNavMenu>
                </MudCardContent>
            </MudCard>
            
            <MudCard Elevation="1" Class="mt-4">
                <MudCardContent>
                    <MudText Typo="Typo.h6" GutterBottom="true">Quick Links</MudText>
                    <MudStack Spacing="2">
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Primary" 
                                  StartIcon="@Icons.Material.Filled.PlayArrow"
                                  Href="/fluent"
                                  FullWidth="true">
                            Try Live Demo
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Secondary" 
                                  StartIcon="@Icons.Custom.Brands.GitHub"
                                  Href="https://github.com"
                                  Target="_blank"
                                  FullWidth="true">
                            View Source
                        </MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .markdown-content h1 {
        font-size: 2.5rem;
        font-weight: 300;
        line-height: 1.2;
        margin-bottom: 1rem;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 0.5rem;
    }
    
    .markdown-content h2 {
        font-size: 2rem;
        font-weight: 400;
        line-height: 1.3;
        margin-top: 2rem;
        margin-bottom: 1rem;
        color: #1976d2;
    }
    
    .markdown-content h3 {
        font-size: 1.5rem;
        font-weight: 500;
        line-height: 1.4;
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
    }
    
    .markdown-content p {
        line-height: 1.6;
        margin-bottom: 1rem;
    }
    
    .markdown-content code {
        background-color: #f5f5f5;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 0.9em;
    }
    
    .markdown-content pre {
        background-color: #f8f8f8;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
        margin: 1rem 0;
    }
    
    .markdown-content pre code {
        background: none;
        padding: 0;
    }
    
    .markdown-content blockquote {
        border-left: 4px solid #1976d2;
        margin: 1rem 0;
        padding-left: 1rem;
        color: #666;
        font-style: italic;
    }
    
    .markdown-content ul, .markdown-content ol {
        margin: 1rem 0;
        padding-left: 2rem;
    }
    
    .markdown-content li {
        margin-bottom: 0.5rem;
        line-height: 1.6;
    }
</style>

@code {
    [Parameter] public string DocumentName { get; set; } = "";
    [Parameter] public string Title { get; set; } = "Documentation";
    
    private bool isLoading = true;
    private string htmlContent = "";
    private List<TocSection> tableOfContents = new();
    
    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(DocumentName))
        {
            await LoadDocumentAsync();
        }
    }
    
    private async Task LoadDocumentAsync()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            var markdown = await MarkdownService.LoadDocumentAsync(DocumentName);
            htmlContent = MarkdownService.ToHtml(markdown);
            ExtractTableOfContents(markdown);
        }
        catch (Exception ex)
        {
            htmlContent = $"<div class='error'>Error loading document: {ex.Message}</div>";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private void ExtractTableOfContents(string markdown)
    {
        tableOfContents.Clear();
        var lines = markdown.Split('\n');
        
        foreach (var line in lines)
        {
            if (line.StartsWith("## "))
            {
                var title = line[3..].Trim();
                var id = title.ToLower().Replace(" ", "-").Replace(".", "");
                tableOfContents.Add(new TocSection { Title = title, Id = id });
            }
        }
    }
    
    private async Task ScrollToSection(string sectionId)
    {
        await JSRuntime.InvokeVoidAsync("scrollToElement", sectionId);
    }
    
    private class TocSection
    {
        public string Title { get; set; } = "";
        public string Id { get; set; } = "";
    }
}